---
title: "crime_analysis"
author: "Shannon Wongvibulsin"
date: "September 11, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Johns Hopkins Security Alert - Crime Analysis & Visualization

## Introduction

Baltimore City consistently ranks as one of the most dangerous cities in America. [Add additional statistics about crime rate, etc.] As a result, discussion about safety concerns at Johns Hopkins is common. To promote a safe and secure environment, the Hopkins Corporate Security provides the University and Hospital communities proactive security and law enforcement practices. Corporate Security maintains a record of the campus crime and provides annual crime statistics. 

The Hopkins Corporate Security crime log represents a rich source of crime data that can be analyzed for crime patterns to determine whether certain types of crime occur more frequently at certain locations, times of day, days of the week, or times of the year. Furthermore, understanding these patterns can help with crime projections to increase campus safety. For example, increased security personnel can be strategically positioned based upon crime patterns. Additionally, although Corporate Security notifies Hopkins of reported crimes that present a “serious or continuing threat” through “Security Alert” emails, detailed analysis of crime patterns can allow Corporate Security to inform the community about general crime “forecasts” as well as general safety precaution recommendations.

## Methods

Using data from the Johns Hopkins Corporate Security Alerts:
1. Develop a street safety score and interactive spatial visualization of the street safety score. 
2. Determine the locations, times, and days of the week with the greatest number of crime reports of each type (assault, theft, etc.), and whether these patterns vary by month or season.

By scraping the Security Alert emails from Corporate_Security@jhmi.edu, I will have crime alert data with information about the campus, incident type, location, date, time, suspect information, and narrative. Using this data, I will be able to calculate street safety scores based upon the rate of crimes and types of crimes. Additionally, I will analyze the data in aggregate to determine locations, times, and days of the week with the greatest number of crime reports of each type (assault, theft, etc.). I will also analyze the data by month and season to determine if there are temporal variations in crime patterns.

references:
http://wtop.com/local/2016/02/d-c-baltimore-city-among-most-dangerous-places-in-u-s/
https://www.forbes.com/pictures/mlj45jggj/7-baltimore/#68a81b8b5487
http://baltimore.cbslocal.com/2017/06/16/baltimore-ranks-on-new-list-of-worst-american-cities-to-live-in/ 
http://www.hopkinsmedicine.org/security_parking_transportation/security/
http://security.jhu.edu/_template-assets/documents/annual_report.pdf

## Inport Data
Data from Johns Hopkins Corporate Security

Data aquisition plan: Data will be obtained by scraping emails sent from Corporate_Security@jhmi.edu with the subject “SECURITY ALERT” through the following steps:
1. Establish forwarding rule to forward all past “SECURITY ALERT” emails from Corporate_Security@jhmi.edu to the email address provided by https://parser.zapier.com/ to extract the data.
2. Create template to extract CAMPUS, INCIDENT TYPE, LOCATION, DATE, TIME, SUSPECT INFORMATION, and NARRATIVE text from emails.

```{r data}
setwd("/Users/purplesw/Dropbox/final_project/data")
dat.15 <- read.csv("2015crimelog.csv")
dat.16 <- read.csv("2016crimelog.csv")
dat.17 <- read.csv("2017crimelog.csv")
```
## Create plots
```{r}

t15 <- table(dat.15$Crime)
d15 <- as.data.frame(t15)
d15$Yr <- "15"
  
t16 <- table(dat.16$Crime)
d16 <- as.data.frame(t16)
d16$Yr <- "16"

t17 <- table(dat.17$Crime)
d17 <- as.data.frame(t17)
d17$Yr <- "17"

total <- rbind(d15, d16)
total <- rbind(total, d17)


library(ggplot2)
library(plotly)

p <- ggplot(data = total, aes(x=Var1, y=Freq, fill = Yr)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

pp <- ggplotly(p) 

pp


```

## Dates
consider season, month, day of week, time

```{r}
library(lubridate)
library(dplyr)
library(reshape2)

#dat.15$day <- weekdays(as.Date(dat.15$Date.Time.Reported))
#dat.15$month <- months(as.Date(dat.15$Date.Time.Reported))
#dat.15$quarter <- quarters(as.Date(dat.15$Date.Time.Reported))

dat.15$date <- sapply(dat.15$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.15$day <- weekdays(dat.15$date)
dat.15$month <- months(dat.15$date)
dat.15$quarter <- quarters(dat.15$date)

dat.15 <- dat.15[-288,]

dw15 <- as.data.frame(table(dat.15$Crime, dat.15$day))

dwm15 <- melt(dw15, c("Var1", "Var2"))

pd <- ggplot(data = dwm15, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ppd <- ggplotly(pd) 

ppd

dw15m <- as.data.frame(table(dat.15$Crime, dat.15$month))

dwm15m <- melt(dw15m, c("Var1", "Var2"))

pm <- ggplot(data = dwm15m, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ppm <- ggplotly(pm) 

ppm

dw15q <- as.data.frame(table(dat.15$Crime, dat.15$quarter))

dwm15q <- melt(dw15q, c("Var1", "Var2"))

pq <- ggplot(data = dwm15q, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ppq <- ggplotly(pq) 

ppq

# seasons

newdat.15$num.month <- match(newdat.15$month, month.name)

newdat.15 <-
newdat.15 %>%
  mutate(Season = ifelse(num.month >= 3 & num.month <= 5, "Spring", 
                          ifelse(num.month >= 6 & num.month <= 8, "Summer",
                            ifelse(num.month >= 9 & num.month <= 11, "Autumn", "Winter"))))

dw15s <- as.data.frame(table(newdat.15$Crime, newdat.15$Season))

dwm15s <- melt(dw15s, c("Var1", "Var2"))

ps <- ggplot(data = dwm15s, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

pps <- ggplotly(ps) 

pps

```

## Location
Need to do text processing of general locations (buildings, areas)
155 unique locations 
look at groupings of general areas
look at correlations of crime types, time and areas
```{r}

```

## To Do
- parse time of day from "Date.Time.Occurred"
- rearrange labels for plots
- add title and axis lables to plots


## Testing tabulizer package

```{r}

library(tabulizer)
library(dplyr)
location <- 'http://www.hopkinsmedicine.org/security_parking_transportation/_downloads/2017.60%20day%20Crime%20Log.pdf'
destfile = "mypdf.pdf"
dl = download.file(location, destfile)
out <- extract_tables(destfile)

library(tabulizer)
library(dplyr)
# Location of WARN notice pdf file
location <- 'http://www.edd.ca.gov/jobs_and_training/warn/WARN-Report-for-7-1-2016-to-10-25-2016.pdf'

# Extract the table
out <- extract_tables(location)
```


